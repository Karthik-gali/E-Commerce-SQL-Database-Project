

-- Step 1: Create the database
CREATE DATABASE ecommerce;

---------------------------------------------

-- Step 2: Switch to or Use the database(ecommerce)
USE ecommerce;

---------------------------------------------
 
-- Create the customers table
CREATE TABLE customers(
id INT AUTO_INCREMENT PRIMARY KEY,
name VARCHAR(100),
email VARCHAR(100),
address VARCHAR(255)
);

---------------------------------------------

-- Create the orders tabe
CREATE TABLE orders(
id INT AUTO_INCREMENT PRIMARY KEY,
customer_id INT,
order_date DATE,
total_amount DECIMAL(10,2),
FOREIGN KEY(customer_id) REFERENCES customers(id)
);

---------------------------------------------

-- Create the products table
CREATE TABLE products(
id INT AUTO_INCREMENT PRIMARY KEY,
name VARCHAR(200),
price DECIMAL(10,2),
description TEXT
);

---------------------------------------------

-- Insert sample customers
INSERT INTO customers (name, email, address) VALUES 
('Bharathi', 'bharathi@example.com', 'Karur'),
('Preethi', 'preethi@example.com', 'Bangalore'),
('Anu', 'anu@example.com', 'Trichy');

 SELECT * FROM customers;

 +----+----------+----------------------+-----------+
| id | name     | email                | address   |
+----+----------+----------------------+-----------+
|  1 | Bharathi | bharathi@example.com | Karur     |
|  2 | Preethi  | preethi@example.com  | Bangalore |
|  3 | Anu      | anu@example.com      | Trichy    |
+----+----------+----------------------+-----------+

---------------------------------------------

-- Insert sample products
Insert INTO products (name, price, description) VALUES 
('Product A', 25.00, 'Basic product'),
('Product B', 50.00, 'Mid-range product'),
('Product C', 60.00, 'Premium product'),
('Product D', 80.00, 'Luxury product');

SELECT * FROM products;

+----+-----------+-------+-------------------+
| id | name      | price | description       |
+----+-----------+-------+-------------------+
|  1 | Product A | 25.00 | Basic product     |
|  2 | Product B | 50.00 | Mid-range product |
|  3 | Product C | 60.00 | Premium product   |
|  4 | Product D | 80.00 | Luxury product    |
+----+-----------+-------+-------------------+

---------------------------------------------

-- Insert sample orders
INSERT INTO orders (customer_id, order_date, total_amount) VALUES
(1, CURDATE(), 100.00),
(2, CURDATE() - INTERVAL 15 DAY, 150.00),
(3, CURDATE() - INTERVAL 40 DAY, 200.00);

SELECT * FROM orders;

+----+-------------+------------+--------------+
| id | customer_id | order_date | total_amount |
+----+-------------+------------+--------------+
|  1 |           1 | 2025-06-10 |       100.00 |
|  2 |           2 | 2025-05-26 |       150.00 |
|  3 |           3 | 2025-05-01 |       200.00 |
+----+-------------+------------+--------------+

---------------------------------------------------------------------------------------------------------------------------

-- QUESTION 1 - Retrieve all customers who have placed an order in the last 30 days

SELECT DISTINCT c.id, c.name, c.email, c.address 
FROM customers AS c 
JOIN orders AS o 
ON c.id = o.customer_id 
WHERE o.order_date >= CURDATE() - INTERVAL 30 DAY;

+----+----------+----------------------+-----------+
| id | name     | email                | address   |
+----+----------+----------------------+-----------+
|  1 | Bharathi | bharathi@example.com | Karur     |
|  2 | Preethi  | preethi@example.com  | Bangalore |
+----+----------+----------------------+-----------+


---------------------------------------------------------------------------------------------------------------------------


-- QUESTION 2 - Get the total amount of all orders placed by each customer

SELECT c.id, c.name,
SUM(o.total_amount) As total_spent
FROM customers AS c
JOIN orders AS o
ON c.id = o.customer_id
GROUP BY c.id, c.name;

+----+----------+-------------+
| id | name     | total_spent |
+----+----------+-------------+
|  1 | Bharathi |      100.00 |
|  2 | Preethi  |      150.00 |
|  3 | Anu      |      200.00 |
+----+----------+-------------+


---------------------------------------------------------------------------------------------------------------------------


-- QUESTION 3 - Update the price of Product C to 45.00

UPDATE products 
SET price = 45.00 
WHERE name = 'Product C';

SELECT * FROM products
WHERE name = 'Product C';

+----+-----------+-------+-----------------+
| id | name      | price | description     |
+----+-----------+-------+-----------------+
|  3 | Product C | 45.00 | Premium product |
+----+-----------+-------+-----------------+


---------------------------------------------------------------------------------------------------------------------------


-- QUESTION 4 - Add a new column discount to the products table

ALTER TABLE products 
ADD COLUMN discount DECIMAL(5,2);

SELECT * FROM products;

+----+-----------+-------+-------------------+----------+
| id | name      | price | description       | discount |
+----+-----------+-------+-------------------+----------+
|  1 | Product A | 25.00 | Basic product     |     NULL |
|  2 | Product B | 50.00 | Mid-range product |     NULL |
|  3 | Product C | 45.00 | Premium product   |     NULL |
|  4 | Product D | 80.00 | Luxury product    |     NULL |
+----+-----------+-------+-------------------+----------+

ALTER TABLE products 
MODIFY COLUMN discount DECIMAL(5,2)
DEFAULT 0.00;

SELECT * FROM products;

+----+-----------+-------+-------------------+----------+
| id | name      | price | description       | discount |
+----+-----------+-------+-------------------+----------+
|  1 | Product A | 25.00 | Basic product     |     NULL |
|  2 | Product B | 50.00 | Mid-range product |     NULL |
|  3 | Product C | 45.00 | Premium product   |     NULL |
|  4 | Product D | 80.00 | Luxury product    |     NULL |
+----+-----------+-------+-------------------+----------+

-- Default values only apply to new rows inserted in the future
-- The default is active but it only works when you insert a new product
-- The existing rows still have NULL you explicitly tell it to

UPDATE products SET discount = 0.00 
WHERE discount IS NULL;

SELECT * FROM products;

+----+-----------+-------+-------------------+----------+
| id | name      | price | description       | discount |
+----+-----------+-------+-------------------+----------+
|  1 | Product A | 25.00 | Basic product     |     0.00 |
|  2 | Product B | 50.00 | Mid-range product |     0.00 |
|  3 | Product C | 45.00 | Premium product   |     0.00 |
|  4 | Product D | 80.00 | Luxury product    |     0.00 |
+----+-----------+-------+-------------------+----------+


---------------------------------------------------------------------------------------------------------------------------


-- QUESTION 5 - Retrieve the top 3 products with the highest price

SELECT * FROM products ORDER BY price DESC limit 3;

+----+-----------+-------+-------------------+----------+
| id | name      | price | description       | discount |
+----+-----------+-------+-------------------+----------+
|  4 | Product D | 80.00 | Luxury product    |     0.00 |
|  2 | Product B | 50.00 | Mid-range product |     0.00 |
|  3 | Product C | 45.00 | Premium product   |     0.00 |
+----+-----------+-------+-------------------+----------+


---------------------------------------------------------------------------------------------------------------------------


-- QUESTION 6 - Get the names of customers who have ordered Product A

CREATE TABLE order_items (
id INT AUTO_INCREMENT PRIMARY KEY,
order_id INT,
product_id INT,
quantity INT,
FOREIGN KEY (order_id) REFERENCES orders(id),
FOREIGN KEY (product_id) REFERENCES products(id)
);


DESCRIBE order_items;
+------------+------+------+-----+---------+----------------+
| Field      | Type | Null | Key | Default | Extra          |
+------------+------+------+-----+---------+----------------+
| id         | int  | NO   | PRI | NULL    | auto_increment |
| order_id   | int  | YES  | MUL | NULL    |                |
| product_id | int  | YES  | MUL | NULL    |                |
| quantity   | int  | YES  |     | NULL    |                |
+------------+------+------+-----+---------+----------------+

INSERT INTO order_items (order_id, product_id, quantity) 
VALUES 
(1, 1, 1),
(2, 2, 1),
(3, 1, 1);


SELECT * FROM order_items;
+----+----------+------------+----------+
| id | order_id | product_id | quantity |
+----+----------+------------+----------+
|  1 |        1 |          1 |        1 |
|  2 |        2 |          2 |        1 |
|  3 |        3 |          1 |        1 |
+----+----------+------------+----------+


SELECT DISTINCT c.id, c.name 
FROM customers AS c 
JOIN orders AS o 
ON c.id = o.customer_id 
JOIN order_items AS oi 
ON o.id = oi.order_id 
JOIN products AS p 
ON oi.product_id = p.id 
WHERE p.name = 'Product C';

+----+----------+
| id | name     |
+----+----------+
|  1 | Bharathi |
|  3 | Anu      |
+----+----------+


---------------------------------------------------------------------------------------------------------------------------


-- QUESTION 7 - Join the orders and customers tables to retrieve the customer's name and order date for each order

SELECT c.name, o.order_date
FROM customers c 
JOIN orders o 
ON c.id = o.customer_id;

+----------+------------+
| name     | order_date |
+----------+------------+
| Bharathi | 2025-06-10 |
| Preethi  | 2025-05-26 |
| Anu      | 2025-05-01 |
+----------+------------+


---------------------------------------------------------------------------------------------------------------------------


-- QUESTION 8 - Retrieve the orders with a total amount greater than 150.00

SELECT * 
FROM orders 
WHERE total_amount > 150.00;

+----+-------------+------------+--------------+
| id | customer_id | order_date | total_amount |
+----+-------------+------------+--------------+
|  3 |           3 | 2025-05-01 |       200.00 |
+----+-------------+------------+--------------+


---------------------------------------------------------------------------------------------------------------------------


-- QUESTION 9 - Normalize the database by creating a separate table for order items and updating the orders table to reference the order_items table


-- Already created the order_items table 

SELECT * FROM order_items;
+----+----------+------------+----------+
| id | order_id | product_id | quantity |
+----+----------+------------+----------+
|  1 |        1 |          1 |        1 |
|  2 |        2 |          2 |        1 |
|  3 |        3 |          1 |        1 |
+----+----------+------------+----------+


-- Adding the price column in order_items table 

ALTER TABLE order_items 
ADD COLUMN price DECIMAL(10,2);


SELECT * FROM order_items;
+----+----------+------------+----------+-------+
| id | order_id | product_id | quantity | price |
+----+----------+------------+----------+-------+
|  1 |        1 |          1 |        1 |  NULL |
|  2 |        2 |          2 |        1 |  NULL |
|  3 |        3 |          1 |        1 |  NULL |
+----+----------+------------+----------+-------+


-- Copy the correct price from products into order_items

UPDATE order_items oi 
JOIN products p ON oi.product_id = p.id 
SET oi.price = p.price;


SELECT * FROM order_items;
+----+----------+------------+----------+-------+
| id | order_id | product_id | quantity | price |
+----+----------+------------+----------+-------+
|  1 |        1 |          1 |        1 | 25.00 |
|  2 |        2 |          2 |        1 | 50.00 |
|  3 |        3 |          1 |        1 | 25.00 |
+----+----------+------------+----------+-------+


-- Calculate total for each order (just to see the correct totals)

SELECT oi.order_id,
SUM(oi.quantity * oi.price) AS total_amount 
FROM order_items AS oi 
GROUP BY oi.order_id;

+----------+--------------+
| order_id | total_amount |
+----------+--------------+
|        1 |        25.00 |
|        2 |        50.00 |
|        3 |        25.00 |
+----------+--------------+


-- Fix the total_amount in the orders table

UPDATE orders o 
JOIN (
SELECT order_id,
SUM(quantity * price) AS total 
FROM order_items 
GROUP BY order_id
) AS totals 
ON o.id = totals.order_id 
SET o.total_amount = totals.total;


SELECT * FROM orders;
+----+-------------+------------+--------------+
| id | customer_id | order_date | total_amount |
+----+-------------+------------+--------------+
|  1 |           1 | 2025-06-10 |        25.00 |
|  2 |           2 | 2025-05-26 |        50.00 |
|  3 |           3 | 2025-05-01 |        25.00 |
+----+-------------+------------+--------------+


---------------------------------------------------------------------------------------------------------------------------


-- QUESTION 10 - Retrieve the average total of all orders

SELECT ROUND(AVG(total_amount),2) AS 
average_order_total 
FROM orders;

+---------------------+
| average_order_total |
+---------------------+
|               33.33 |
+---------------------+

----------------------------------------------------------------xxx-----------------------------------------------------------
